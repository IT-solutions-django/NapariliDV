{% extends 'base.html' %}
{% load static %}

{% block title %}Галерея - Напарили ДВ{% endblock %}

{% block content %}
<div id="mobileGalleryOverlay">
    <div id="mobileGalleryProject">
        <div class="mobile-catalog__close-button" id="closeMobileProject">
            <button>
                <img src="{% static 'images/mobile-filters-close.svg' %}" alt="">
            </button>
        </div>
        <div class="mobile-gallery__heading mobile-container">
            <h4>Каркасный дом БАРН</h4>
            <hr>
        </div>
        <div class="mobile-container">
            <div class="article__paragraph-text">
                <p>Однозначно, сторонники тоталитаризма в науке заблокированы в рамках своих собственных рациональных ограничений. Кстати, акционеры крупнейших компаний призывают нас к новым свершениям, которые, в свою очередь, должны быть объявлены нарушающими общечеловеческие нормы этики и морали! Предварительные выводы неутешительны: глубокий уровень погружения однозначно фиксирует необходимость позиций</p>
                <p>Каркасный дом - это дом, в основе которого есть несущий деревянный каркас. Он в свою очередь заполняется современными материалами для влаго-, ветро- и теплозащиты: Изоспан А, изоспин В, утеплитель Технониколь, и обшивается отделочными материалами (панели «Доке, имитация бруса, Данил «Ханья»). По завершении работ стена каркасного дома напоминает слоеный пиро</p>    
            </div>
        </div>
        <div>
            <div class="best-projects__card-content">
                <ul class="table-of-contents">
                    <li><span>Этажи</span><span>1</span></li>
                    <li><span>Площадь</span><span>204,0 м2</span></li>
                    <li><span>Количество спален</span><span>3</span></li>
                    <li><span>Количество санузлов</span><span>2</span></li>
                    <li><span>Материал</span><span>Каркас</span></li>
                    <li><span>Кровля</span><span>Металлочерепица</span></li>
                    <li><span>Стоимость</span><span>от 5 300 000 р</span></li>
                </ul>
            </div>
        </div>

        <div>
            <div class="gallery">            
                <div class="gallery__slider">
                    {% for project in gallery_photos %}
                    <div class="gallery__photo">
                        <img src="{{ project.gallery_photo.url }}" alt="">
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="breadcrumbs container font__inter">
    <div>
        <a href="{% url 'home:home' %}">Главная</a>
    </div>
    <div>
        <img src="{% static 'images/right-gray-arrow.svg' %}" alt="">
    </div>
    <div>
        <a href="{% url 'contacts:gallery' %}">Галерея</a>
    </div>
</div>
<div class="gallery-page">
    <div class="news-page__header container">
        <div class="news__heading">
            <h1>Галерея</h1>
        </div>
        <hr class="news-page__header-hr--adaptive">
        <div class="news__header-right-buttons">
            <form id="galleryForm" action="{% url 'blog:blog' %}">
                {% for category in filter_form.category %}
                    <div class="news__header-button">
                        {{ choice.tag }}
                        <input 
                            type="radio"
                            name="{{ category.data.name }}" 
                            value="{{ category.data.value }}"
                            class="radio-toggle"
                            id="{{ category.id_for_label }}" 
                            {% if category.data.selected %}checked data-was-checked="true"{% endif %}
                        >
                        <label for="{{ category.id_for_label }}">{{ category.choice_label }}</label>
                    </div>
                {% endfor %}
            </form>
        </div>
    </div>
    <hr class="news-page__header-hr container">
    <div class="container">
        <div class="article__content">
            <div class="article__content-block">
                <div class="article__paragraph">
                    <div class="article__paragraph-heading">
                        Внезапно, герцог графства коронован
                    </div>
                    <div class="article__paragraph-text font__inter">
                        Однозначно, сторонники тоталитаризма в науке заблокированы в рамках своих собственных рациональных ограничений. Кстати, акционеры крупнейших компаний призывают нас к новым свершениям, которые, в свою очередь, должны быть объявлены нарушающими общечеловеческие нормы этики и морали! Предварительные выводы неутешительны: глубокий уровень погружения однозначно фиксирует необходимость позиций, занимаемых участниками в отношении поставленных задач
        Каркасный дом - это дом, в основе которого есть несущий деревянный каркас. Он в свою очередь заполняется современными материалами для влаго-, ветро- и теплозащиты: Изоспан А, изоспин В, утеплитель Технониколь, и обшивается отделочными материалами (панели «Доке, имитация бруса, Данил «Ханья»). По завершении работ стена каркасного дома напоминает слоеный пиро
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="gallery-page__slider">
        {% for project in gallery_photos %}
            <div class="gallery-page__photo openMobileProject" data-project-id="{{ project.id }}">
                <img src="{{ project.gallery_photo.url }}" alt="">
            </div>
        {% endfor %}
    </div>
    
</div>

<div class="about">
    <div class="contacts container">
        <div class="contacts__small-left-column">
            <div class="contacts__heading">
                <h4>Контакты</h4>
            </div>
            <div class="contacts__info">
                <div class="contacts__block">
                    <div>
                        <img src="{% static 'images/contacts-icon-1.svg' %}" alt="">
                    </div>
                    <div>
                        <div class="contacts__block-heading">
                            <a href="{{ company_info.two_gis_profile }}">Главный офис:</a>
                        </div>
                        <div class="font__inter">
                            <a href="{{ company_info.two_gis_profile }}" class="font__inter">{{ company_info.address }}</a>
                        </div>
                    </div>
                </div>
                <div class="contacts__block">
                    <div>
                        <img src="{% static 'images/contacts-icon-2.svg' %}" alt="">
                    </div>
                    <div>
                        <div class="contacts__block-heading">
                            <p>Время работы:</p>
                        </div>
                        <div class="font__inter">
                            <p>{{ company_info.working_mode }}</p>
                        </div>
                    </div>
                </div>
                <div class="contacts__block">
                    <div>
                        <img src="{% static 'images/contacts-icon-3.svg' %}" alt="">
                    </div>
                    <div>
                        <div class="contacts__block-heading">
                            <a href="tel:{{ company_info.phone }}">Телефон:</a>
                        </div>
                        <div class="font__inter">
                            <a href="tel:{{ company_info.phone }}" class="font__inter">{{ company_info.phone }}</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="contacts__big-right-column">
            <div class="map" id="map">

            </div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block script %}
<script>
// Функции
function initGallerySlider(selector) {
    const slider = $(selector);
    if (slider.length) {
        slider.slick({
            centerMode: true,
            arrows: true,
            infinite: true,
            slidesToShow: 1.7,
            slidesToScroll: 1,
            responsive: [, 
                {
                    breakpoint: 1600, 
                    settings: {
                        slidesToShow: 1.6, 
                        slidesToScroll: 1
                    }
                },
                {
                    breakpoint: 1024, 
                    settings: {
                        slidesToShow: 1, 
                        slidesToScroll: 1
                    }
                },
            ]
        });
    } else {
        console.warn(`Элемента ${selector} не существует!`);
    }
}
function initMobileSlider(selector) {
    const slider = $(selector);
    if (slider.length) {
        slider.slick({
            centerMode: true,
            arrows: true,
            infinite: true,
            slidesToShow: 3,
            slidesToScroll: 1,
            responsive: [
                {
                    breakpoint: 1200,
                    settings: {
                        slidesToShow: 2,
                        slidesToScroll: 1
                    }
                },
                {
                    breakpoint: 1024,
                    settings: {
                        slidesToShow: 1,
                        slidesToScroll: 1
                    }
                },
                {
                    breakpoint: 768,
                    settings: {
                        slidesToShow: 1,
                        slidesToScroll: 1
                    }
                },
                {
                    breakpoint: 576,
                    settings: {
                        centerMode: true,
                        slidesToShow: 1,
                        slidesToScroll: 1
                    }
                }
            ]
        });
    } else {
        console.warn(`Элемента ${selector} не существует!`);
    }
}
function initMobileProject() {
    const openButtons = document.querySelectorAll(".openMobileProject");
    const filterFormContainer = document.getElementById("mobileGalleryProject");
    const filterOverlay = document.getElementById("mobileGalleryOverlay");
    const closeFiltersBtn = document.getElementById("closeMobileProject");

    // Функция для открытия формы
    function openFilters() {
        filterFormContainer.style.display = "flex";
        filterOverlay.style.display = "flex";
        document.body.classList.add("scroll-disabled");
        
        const projectId = event.target.closest(".openMobileProject").dataset.projectId;
        console.log(projectId)

        $.ajax({
            url: `${window.origin}/contacts/api/gallery-details/${projectId}/`, 
            method: "GET",
            dataType: "json",
            success: function (response) {
                filterFormContainer.innerHTML = response.html;

                // Инициализируем слайдер после вставки данных
                initMobileSlider(".gallery__slider");

                // Переназначаем кнопку закрытия после обновления HTML
                const newCloseFiltersBtn = document.getElementById("closeMobileProject");
                if (newCloseFiltersBtn) {
                    newCloseFiltersBtn.addEventListener("click", closeFilters);
                }
            },
            error: function (xhr, status, error) {
                console.error("Ошибка загрузки данных:", error);
            }
        });

        $(document).ready(function () {
            initMobileSlider(".gallery__slider");
        });
    }

    // Функция для закрытия формы
    function closeFilters() {
        filterFormContainer.style.display = "none";
        filterOverlay.style.display = "none";
        document.body.classList.remove("scroll-disabled");
    }

    openButtons.forEach(function (button) {
        button.addEventListener("click", openFilters);
    });

    if (closeFiltersBtn) {
        closeFiltersBtn.addEventListener("click", closeFilters);
    }
}

$(document).ready(function () {
    initGallerySlider('.gallery-page__slider')
});

var myMap;
ymaps.ready(function(){
    myMap = new ymaps.Map("map", {
        center: [43.157062, 131.926061], 
        zoom: 16, 
        controls: []
    });
    var o = new ymaps.control.ZoomControl({
          options: {
              position: {
                  right: 10,
                  top: 50
              },
              size: "small"
          }
      });
    myMap.controls.add(o);
    myMap.behaviors.disable("scrollZoom");
    var s = new ymaps.Placemark([43.157062, 131.926061], {
              hintContent: "Волгоградская улица, 7А",
              balloonContent: "Волгоградская улица, 7А"
          }, {
              iconLayout: "default#image",
              iconImageHref: `/static/images/pin.svg`,
              iconImageSize: [50, 50],
              iconImageOffset: [-15, -42]
          });
    myMap.geoObjects.add(s);
}); 
    // Фильтрация фотографий в галерее
    $(document).ready(function() {
        $('#galleryForm input').on('change input', function(event) {
            let formData = $('#galleryForm').serialize();
            let gallerySliderContainer = $('.gallery-page__slider');
            console.log(gallerySliderContainer)
    
            let timeout = setTimeout(function () {
                $.ajax({
                    url: "{% url 'contacts:gallery_filters' %}",  
                    type: "GET",
                    data: formData,
                    success: function(response) {
                        $('.gallery-page__slider').replaceWith(response.html);
                        console.log(response.html)

                        // Инициализация слайдера
                        $(document).ready(function () {
                            initGallerySlider(".gallery-page__slider");
                            initMobileProject();
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error("Ошибка при фильтрации:", error);
                    }
                });
            }, 200);      
        });
    });

    // Сброс input radio
    document.addEventListener("DOMContentLoaded", function () {
    const radioButtons = document.querySelectorAll('.radio-toggle');

    radioButtons.forEach(function (radio) {
        radio.addEventListener('click', function () {
            if (this.dataset.wasChecked === "true") {
                this.checked = false;
                this.dataset.wasChecked = "false";
            } else {
                this.dataset.wasChecked = "true";
            }

            radioButtons.forEach(function (otherRadio) {
                if (otherRadio !== radio && otherRadio.name == radio.name) {
                    otherRadio.dataset.wasChecked = "false";
                }
            });

            // Применение новых фильтров
            let formData = $('#galleryForm').serialize();
            let gallerySliderContainer = $('.gallery-page__slider');

            timeout = setTimeout(function () {
                $.ajax({
                    url: "{% url 'contacts:gallery_filters' %}",  
                    type: "GET",
                    data: formData,
                    success: function(response) {
                        gallerySliderContainer.replaceWith(response.html);

                        // Инициализация слайдера и мобильной формы
                        $(document).ready(function () {
                            initGallerySlider(".gallery-page__slider")
                            initMobileProject();
                        });                        
                        
                    },
                    error: function(xhr, status, error) {
                        console.error("Ошибка при фильтрации:", error);
                    }
                });
            }, 200);
        });
    });
});

document.addEventListener("DOMContentLoaded", function () {
    initMobileProject();
});
</script>
{% endblock %}